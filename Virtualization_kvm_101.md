* [目录](#0)
  * [虚拟机启停等日常命令](#1)
  * [KVM运行环境的安装](#2)
  * [删除默认的virbr0, 并新建一个网桥用于KVM虚拟机的桥接网络](#3)
  * [KVM虚拟机控制台连接的方式](#4)

    
<h3 id="1">虚拟机启停等日常命令</h3>
https://bynss.com/linux/520925.html  
```
# 启动虚拟机
virsh start 虚拟机名称

# 查看当前正在运行的虚拟机
virsh list

# 查看所有虚拟机, 包括停止的
virsh list --all

# 保存虚拟机内存状态并停止虚拟机
virsh save 虚拟机名称 保存点名称

# 还原虚拟机--使用virsh save的保存点
virsh restore 保存点名称

# 重启虚拟机
virsh reboot 虚拟机名称

# 挂起/暂停虚拟机
virsh suspend 虚拟机名称

# 恢复挂起/暂停的虚拟机
virsh resume 虚拟机名称

# 停止活动的虚拟机--destroy并不是删除虚拟机
virsh destroy 虚拟机名称

# 停止活动的虚拟机--等待虚拟机事务自行结束
virsh destroy 虚拟机名称 --graceful

# 关闭虚拟机
virsh shutdown 虚拟机名称

# 输出虚拟机的配置定义文件
virsh dumpxml 虚拟机名称

# 输出虚拟机的配置定义文件, 重定向到文件
virsh dumpxml 虚拟机名称 > 文件名称.xml

# 从XML文件创建虚拟机
virsh create 文件名称.xml

# 编辑虚拟机 XML 配置文件--这是编辑的虚拟机的配置文件, 不是导出的副本; 
# 编辑器取决于你的$EDITOR 变量设置
virsh edit 虚拟机名称

# virt-install --os-variant 可选值
osinfo-query os
```

<h3 id="2">KVM运行环境的安装</h3>
https://bynss.com/linux/591489.html#  
https://www.liuwg.com/archives/kvm  
在RHEL / CentOS / Rocky 8.x上的安装示例
```
[root@localhost /]# yum -y install qemu-kvm  libvirt libvirt-daemon  \
libvirt-client  libvirt-daemon-driver-qemu \
virt-manager virt-install  virt-viewer virt-v2v
```
软件包介绍：  
qemu-kvm: 为kvm提供底层仿真支持；  
libvirt-daemon: libvirtd守护进程，管理虚拟机；  
libvirt-client: 用户端软件，提供客户端管理命令；  
libvirt-daemon-driver-qemu: libvirtd连接qemu的驱动；  
libvirt: 虚拟管理模块；  
virt-manager: 图形界面管理工具；  
virt-install: 虚拟机命令行安装工具；  
virt-v2v: 虚拟机迁移工具；  

开机启动
```
[root@localhost /]# systemctl start libvirtd 
[root@localhost /]# systemctl enable libvirtd
```

<h3 id="3">删除默认的virbr0, 并新建一个网桥用于KVM虚拟机的桥接网络</h3>
https://www.liuwg.com/archives/kvm-bridge  


<h3 id="4">KVM虚拟机控制台连接的方式</h3>
#### console直连
https://blog.csdn.net/lemontree1945/article/details/80461037  
https://www.cnblogs.com/xieshengsen/p/6215168.html  
前两篇内容相同  
https://blog.csdn.net/qq_36885515/article/details/112367143  
https://www.igiftidea.com/article/11397774301.html  
- 对于RHEL 6版本的虚拟机的配置步骤  
1) 添加ttyS0的许可，允许root登陆
```
echo "ttyS0" >> /etc/securetty
```
2) 编辑/etc/grub.conf中加入console=ttyS0
```
[root@localhost ~]# less /etc/grub.conf 
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root
#          initrd /initrd-[generic-]version.img
#boot=/dev/sda
default=0
timeout=5
splashimage=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
title CentOS (2.6.32-431.el6.x86_64)
        root (hd0,0)
        kernel /vmlinuz-2.6.32-431.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGroup/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=128M rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet console=ttyS0
        initrd /initramfs-2.6.32-431.el6.x86_64.img
[root@localhost ~]#
```
也就是在当前使用的内核版本追加一个参数 ```console=ttyS0```
3) 编辑/etc/inittab，在最后一行加入内容
```
S0:12345:respawn:/sbin/agetty ttyS0 115200
```
4) 最后重启生效

- 对于RHEL 7版本的虚拟机的配置步骤
```
grubby --update-kernel=ALL --args="console=ttyS0"
reboot
```

- 退出console会话
退出console会话是按下ctrl+] 的组合键, 但没有特别的提示, 如果主机名没有区别, 看起来像是只是回车换了行, 通过 IP信息等方式来确定到底在哪台主机上,这个细节需要注意.

#### VNC连接充当显示器
在创建虚拟机阶段, 使用virt-install 的 --graphics 参数可将虚拟机的图形输出定向到VNC连接  
虚拟机已经创建的, 也可以通过virsh edit 编辑配置文件追加上  
示例:
```
virt-install \
--virt-type=kvm \
--name centos6.10 \
--memory 1024 \
--vcpus=1 \
--os-variant=rhel6.10 \
--noautoconsole \
--cdrom=/mnt/PC_to_storage/ISO/Linux/CentOS-6.10-x86_64-bin-DVD1.iso \
--network=bridge=br0,model=virtio \
--graphics vnc,listen=0.0.0.0,port=5903 \
--disk path=/vm/centos6.qcow2,size=20,bus=virtio,format=qcow2
```
其中两个参数起作用
```
# 让KVM不要自动创建console连接
--noautoconsole

# 将图形显示定向到VNC, 并且指定监听端口和IP
--graphics vnc,listen=0.0.0.0,port=5903
```
